import React, { useState } from 'react';
import { View, StyleSheet, ScrollView, RefreshControl, Animated } from 'react-native';
import { Text, Card, ActivityIndicator, Chip, Surface } from 'react-native-paper';
import { BarChart3, TrendingUp, Users, BookOpen, DollarSign, Calendar, Award, Target, Zap, AlertCircle } from 'lucide-react-native';
import { useAuth } from '../../src/contexts/AuthContext';
import { useClassSelection } from '../../src/contexts/ClassSelectionContext';
import { ClassSelector } from '../../src/components/ClassSelector';
import { colors, typography, spacing, borderRadius } from '../../lib/design-system';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '../../src/lib/supabase';
import { KPICard, TrendChart, ProgressRing } from '../../src/components/analytics';
import type { DataPoint } from '../../src/components/analytics';

interface SuperAdminAnalytics {
  attendance: {
    avgRate: number;
    trend7Days: Array<{ date: string; rate: number }>;
    trend30Days: Array<{ date: string; rate: number }>;
    classesByConsistency: Array<{
      classId: string;
      className: string;
      avgRate: number;
      trend: 'improving' | 'stable';
    }>;
  };
  academics: {
    avgScoreBySubject: Array<{
      subjectId: string;
      subjectName: string;
      avgScore: number;
      participationRate: number;
    }>;
    participationRate: number;
  };
  fees: {
    realizationRate: number;
    totalBilled: number;
    totalCollected: number;
    totalOutstanding: number;
    agingBuckets: {
      current: number;
      '30to60': number;
      '60to90': number;
      over90: number;
    };
  };
  operations: {
    timetableCoverage: number;
    teacherLoadBalance: Array<{
      teacherId: string;
      teacherName: string;
      totalPeriods: number;
      conductedPeriods: number;
    }>;
  };
  engagement: {
    testParticipation: number;
    taskSubmissionRate: number;
  };
  summary: {
    totalStudents: number;
    totalClasses: number;
    totalTeachers: number;
    activeAcademicYear: string;
  };
}

interface AdminAnalytics {
  presence: {
    weeklyTrend: Array<{
      date: string;
      rate: number;
      presentCount: number;
      totalStudents: number;
    }>;
    steadyParticipation: number;
    currentRate: number;
  };
  learning: {
    quizAvgTrend: Array<{ date: string; avgScore: number }>;
    assignmentOnTimeRate: number;
    subjectCompletion: Array<{
      subjectId: string;
      subjectName: string;
      completionPercent: number;
    }>;
  };
  syllabus: {
    progressBySubject: Array<{
      subjectId: string;
      subjectName: string;
      completedTopics: number;
      totalTopics: number;
      progress: number;
    }>;
  };
  operations: {
    plannedPeriods: number;
    conductedPeriods: number;
    coveragePercent: number;
    weeklyTrend: Array<{
      date: string;
      planned: number;
      conducted: number;
      coverage: number;
    }>;
  };
  engagement: {
    quizParticipation: number;
    assignmentParticipation: number;
  };
  summary: {
    className: string;
    totalStudents: number;
    classTeacher: string;
  };
}

interface StudentAnalytics {
  attendanceRhythm: {
    daysAttendedThisMonth: number;
    totalDaysThisMonth: number;
    fourWeekTrend: Array<{
      week: number;
      presentDays: number;
      totalDays: number;
      rate: number;
    }>;
    currentRate: number;
  };
  learning: {
    subjectScoreTrend: Array<{
      subjectId: string;
      subjectName: string;
      avgScore: number;
      testCount: number;
      recentTrend: Array<{ date: string; score: number }>;
    }>;
    assignmentOnTimeStreak: number;
    totalAssignments: number;
  };
  progressHighlights: {
    closestToPersonalBest: {
      subjectId: string;
      subjectName: string;
      bestScore: number;
      recentScore: number;
    };
    syllabusProgress: Array<{
      subjectId: string;
      subjectName: string;
      completedTopics: number;
      totalTopics: number;
      progress: number;
    }>;
  };
  fees: {
    totalBilled: number;
    totalPaid: number;
    totalDue: number;
    lastPaymentDate: string | null;
    status: 'paid' | 'current' | 'overdue' | 'no_billing';
  };
  summary: {
    studentName: string;
    className: string;
    schoolName: string;
  };
}

// Empty State Component
const EmptyState: React.FC<{ icon: any; title: string; message: string }> = ({ icon: Icon, title, message }) => (
  <View style={styles.emptyState}>
    <View style={styles.emptyIconContainer}>
      <Icon size={48} color={colors.text.tertiary} strokeWidth={1.5} />
    </View>
    <Text variant="titleMedium" style={styles.emptyTitle}>{title}</Text>
    <Text variant="bodyMedium" style={styles.emptyMessage}>{message}</Text>
  </View>
);

// Skeleton Loader Component
const SkeletonCard: React.FC = () => (
  <View style={styles.skeletonCard}>
    <View style={styles.skeletonTitle} />
    <View style={styles.skeletonLine} />
    <View style={[styles.skeletonLine, { width: '60%' }]} />
  </View>
);

// Feature Card Component
const FeatureCard: React.FC<{
  icon: any;
  title: string;
  value: string;
  subtitle: string;
  color: string;
  onPress: () => void;
}> = ({ icon: Icon, title, value, subtitle, color, onPress }) => (
  <Surface style={styles.featureCard} elevation={1}>
    <View style={[styles.featureIconBg, { backgroundColor: color + '15' }]}>
      <Icon size={28} color={color} />
    </View>
    <Text variant="labelMedium" style={styles.featureCardTitle}>{title}</Text>
    <Text variant="displaySmall" style={[styles.featureCardValue, { color }]}>{value}</Text>
    <Text variant="bodySmall" style={styles.featureCardSubtitle}>{subtitle}</Text>
  </Surface>
);

// Super Admin Dashboard Component
const SuperAdminDashboard: React.FC<{ data: SuperAdminAnalytics; isLoading: boolean }> = ({
  data,
  isLoading,
}) => {
  const [selectedFeature, setSelectedFeature] = useState<'attendance' | 'fees' | 'learning' | 'overview'>('overview');
  const [timePeriod, setTimePeriod] = useState<'daily' | 'weekly' | 'monthly'>('weekly');

  if (isLoading) {
    return (
      <View style={styles.tabContent}>
        <SkeletonCard />
        <SkeletonCard />
        <SkeletonCard />
      </View>
    );
  }

  const hasData = data?.summary?.totalStudents > 0;

  if (!hasData) {
    return (
      <View style={styles.tabContent}>
        <EmptyState
          icon={BarChart3}
          title="No Data Available"
          message="Analytics will appear here once students start using the system. Run the analytics refresh to populate data."
        />
      </View>
    );
  }

  const attendanceRate = data?.attendance?.avgRate || 0;
  const getAttendanceColor = (rate: number) => {
    if (rate >= 90) return colors.success[600];
    if (rate >= 80) return colors.warning[600];
    return colors.error[600];
  };

  // Render feature-specific view
  const renderFeatureView = () => {
    switch (selectedFeature) {
      case 'attendance':
        return <AttendanceDetailView data={data} timePeriod={timePeriod} setTimePeriod={setTimePeriod} />;
      case 'fees':
        return <FeesDetailView data={data} timePeriod={timePeriod} setTimePeriod={setTimePeriod} />;
      case 'learning':
        return <LearningDetailView data={data} timePeriod={timePeriod} setTimePeriod={setTimePeriod} />;
      default:
        return null;
    }
  };

  // Overview Feature Cards
  if (selectedFeature === 'overview') {
    return (
      <View style={styles.tabContent}>
        {/* School Summary */}
        <View style={styles.summaryHeader}>
          <Text variant="headlineSmall" style={styles.summaryTitle}>
            {data?.summary?.activeAcademicYear}
          </Text>
          <View style={styles.summaryStats}>
            <View style={styles.summaryStatItem}>
              <Text variant="bodySmall" style={styles.summaryStatLabel}>Students</Text>
              <Text variant="titleLarge" style={styles.summaryStatValue}>{data?.summary?.totalStudents}</Text>
            </View>
            <View style={styles.summaryDivider} />
            <View style={styles.summaryStatItem}>
              <Text variant="bodySmall" style={styles.summaryStatLabel}>Classes</Text>
              <Text variant="titleLarge" style={styles.summaryStatValue}>{data?.summary?.totalClasses}</Text>
            </View>
            <View style={styles.summaryDivider} />
            <View style={styles.summaryStatItem}>
              <Text variant="bodySmall" style={styles.summaryStatLabel}>Teachers</Text>
              <Text variant="titleLarge" style={styles.summaryStatValue}>{data?.summary?.totalTeachers}</Text>
            </View>
          </View>
        </View>

        {/* Feature Selection Cards */}
        <Text variant="titleMedium" style={styles.sectionLabel}>Select a feature to analyze</Text>

        <View style={styles.featureGrid}>
          <Surface
            style={styles.featureCard}
            elevation={2}
            onTouchEnd={() => setSelectedFeature('attendance')}
          >
            <View style={[styles.featureIconBg, { backgroundColor: colors.success[50] }]}>
              <Users size={32} color={colors.success[600]} />
            </View>
            <Text variant="titleMedium" style={styles.featureCardTitle}>Attendance</Text>
            <Text variant="displayMedium" style={[styles.featureCardValue, { color: getAttendanceColor(attendanceRate) }]}>
              {Math.round(attendanceRate)}%
            </Text>
            <Text variant="bodySmall" style={styles.featureCardSubtitle}>Overall rate</Text>
            <Chip
              mode="flat"
              style={{ backgroundColor: attendanceRate >= 90 ? colors.success[50] : colors.warning[50], marginTop: spacing.sm }}
              textStyle={{ color: attendanceRate >= 90 ? colors.success[700] : colors.warning[700], fontSize: 11 }}
            >
              {attendanceRate >= 90 ? 'Excellent' : 'Needs Focus'}
            </Chip>
          </Surface>

          <Surface
            style={styles.featureCard}
            elevation={2}
            onTouchEnd={() => setSelectedFeature('fees')}
          >
            <View style={[styles.featureIconBg, { backgroundColor: colors.primary[50] }]}>
              <DollarSign size={32} color={colors.primary[600]} />
            </View>
            <Text variant="titleMedium" style={styles.featureCardTitle}>Fee Collection</Text>
            <Text variant="displayMedium" style={[styles.featureCardValue, { color: colors.primary[600] }]}>
              {Math.round(data?.fees?.realizationRate || 0)}%
            </Text>
            <Text variant="bodySmall" style={styles.featureCardSubtitle}>Realization rate</Text>
            <Text variant="bodySmall" style={[styles.featureCardSubtitle, { color: colors.error[600], marginTop: spacing.xs }]}>
              ₹{((data?.fees?.totalOutstanding || 0) / 100).toLocaleString('en-IN')} due
            </Text>
          </Surface>

          <Surface
            style={styles.featureCard}
            elevation={2}
            onTouchEnd={() => setSelectedFeature('learning')}
          >
            <View style={[styles.featureIconBg, { backgroundColor: colors.info[50] }]}>
              <Target size={32} color={colors.info[600]} />
            </View>
            <Text variant="titleMedium" style={styles.featureCardTitle}>Learning</Text>
            <Text variant="displayMedium" style={[styles.featureCardValue, { color: colors.info[600] }]}>
              {Math.round(data?.academics?.participationRate || 0)}%
            </Text>
            <Text variant="bodySmall" style={styles.featureCardSubtitle}>Test participation</Text>
            <Text variant="bodySmall" style={[styles.featureCardSubtitle, { marginTop: spacing.xs }]}>
              {data?.academics?.avgScoreBySubject?.length || 0} subjects tracked
            </Text>
          </Surface>

          <Surface
            style={styles.featureCard}
            elevation={2}
          >
            <View style={[styles.featureIconBg, { backgroundColor: colors.warning[50] }]}>
              <Calendar size={32} color={colors.warning[600]} />
            </View>
            <Text variant="titleMedium" style={styles.featureCardTitle}>Operations</Text>
            <Text variant="displayMedium" style={[styles.featureCardValue, { color: colors.warning[600] }]}>
              {Math.round(data?.operations?.timetableCoverage || 0)}%
            </Text>
            <Text variant="bodySmall" style={styles.featureCardSubtitle}>Timetable coverage</Text>
            <Text variant="bodySmall" style={[styles.featureCardSubtitle, { marginTop: spacing.xs }]}>
              {Math.round(data?.engagement?.taskSubmissionRate || 0)}% task submission
            </Text>
          </Surface>
        </View>
      </View>
    );
  }

  return (
    <View style={styles.tabContent}>
      {/* Back Button */}
      <Surface style={styles.backButton} elevation={1} onTouchEnd={() => setSelectedFeature('overview')}>
        <Text variant="labelLarge" style={styles.backButtonText}>← Back to Overview</Text>
      </Surface>

      {/* Render selected feature view */}
      {renderFeatureView()}
    </View>
  );
};

// Attendance Detail View Component
const AttendanceDetailView: React.FC<{
  data: SuperAdminAnalytics;
  timePeriod: 'daily' | 'weekly' | 'monthly';
  setTimePeriod: (period: 'daily' | 'weekly' | 'monthly') => void;
}> = ({ data, timePeriod, setTimePeriod }) => {
  const getAttendanceColor = (rate: number) => {
    if (rate >= 90) return colors.success[600];
    if (rate >= 80) return colors.warning[600];
    return colors.error[600];
  };

  return (
    <>
      {/* Time Period Filter Chips */}
      <View style={styles.filterChips}>
        <Chip
          selected={timePeriod === 'daily'}
          onPress={() => setTimePeriod('daily')}
          style={styles.filterChip}
        >
          Daily
        </Chip>
        <Chip
          selected={timePeriod === 'weekly'}
          onPress={() => setTimePeriod('weekly')}
          style={styles.filterChip}
        >
          Weekly
        </Chip>
        <Chip
          selected={timePeriod === 'monthly'}
          onPress={() => setTimePeriod('monthly')}
          style={styles.filterChip}
        >
          Monthly
        </Chip>
      </View>

      {/* Main Metric Card */}
      <Surface style={styles.metricCardLarge} elevation={2}>
        <Text variant="labelLarge" style={styles.metricCardLabel}>Overall Attendance Rate</Text>
        <Text variant="displayLarge" style={[styles.metricCardValue, { color: getAttendanceColor(data?.attendance?.avgRate || 0) }]}>
          {Math.round(data?.attendance?.avgRate || 0)}%
        </Text>
        <Text variant="bodySmall" style={styles.metricCardSubtext}>Last 30 days average</Text>
      </Surface>

      {/* Comparison Chart - Top Classes */}
      {data?.attendance?.classesByConsistency && data.attendance.classesByConsistency.length > 0 && (
        <Surface style={styles.chartCard} elevation={1}>
          <Text variant="titleMedium" style={styles.chartTitle}>Class-wise Comparison</Text>
          <Text variant="bodySmall" style={styles.chartSubtitle}>Top performing classes</Text>

          {data.attendance.classesByConsistency.slice(0, 5).map((classItem) => (
            <View key={classItem.classId} style={styles.comparisonItem}>
              <Text variant="bodyMedium" style={styles.comparisonLabel}>{classItem.className}</Text>
              <View style={styles.comparisonBarContainer}>
                <View
                  style={[
                    styles.comparisonBar,
                    {
                      width: `${classItem.avgRate}%`,
                      backgroundColor: getAttendanceColor(classItem.avgRate),
                    },
                  ]}
                />
                <Text variant="labelMedium" style={[styles.comparisonValue, { color: getAttendanceColor(classItem.avgRate) }]}>
                  {Math.round(classItem.avgRate)}%
                </Text>
              </View>
            </View>
          ))}
        </Surface>
      )}
    </>
  );
};

// Fees Detail View Component
const FeesDetailView: React.FC<{
  data: SuperAdminAnalytics;
  timePeriod: 'daily' | 'weekly' | 'monthly';
  setTimePeriod: (period: 'daily' | 'weekly' | 'monthly') => void;
}> = ({ data, timePeriod, setTimePeriod }) => {
  return (
    <>
      {/* Time Period Filter Chips */}
      <View style={styles.filterChips}>
        <Chip
          selected={timePeriod === 'daily'}
          onPress={() => setTimePeriod('daily')}
          style={styles.filterChip}
        >
          Daily
        </Chip>
        <Chip
          selected={timePeriod === 'weekly'}
          onPress={() => setTimePeriod('weekly')}
          style={styles.filterChip}
        >
          Weekly
        </Chip>
        <Chip
          selected={timePeriod === 'monthly'}
          onPress={() => setTimePeriod('monthly')}
          style={styles.filterChip}
        >
          Monthly
        </Chip>
      </View>

      {/* Realization Rate */}
      <Surface style={styles.metricCardLarge} elevation={2}>
        <Text variant="labelLarge" style={styles.metricCardLabel}>Fee Realization Rate</Text>
        <Text variant="displayLarge" style={[styles.metricCardValue, { color: colors.primary[600] }]}>
          {Math.round(data?.fees?.realizationRate || 0)}%
        </Text>
        <Text variant="bodySmall" style={styles.metricCardSubtext}>of billed fees collected</Text>
      </Surface>

      {/* Collected vs Outstanding Comparison */}
      <Surface style={styles.chartCard} elevation={1}>
        <Text variant="titleMedium" style={styles.chartTitle}>Collection Overview</Text>

        <View style={styles.feeComparisonContainer}>
          <View style={styles.feeComparisonItem}>
            <View style={[styles.feeComparisonBar, { height: `${(data?.fees?.totalCollected / (data?.fees?.totalBilled || 1)) * 100}%`, backgroundColor: colors.success[600] }]} />
            <Text variant="labelSmall" style={styles.feeComparisonLabel}>Collected</Text>
            <Text variant="titleMedium" style={[styles.feeComparisonValue, { color: colors.success[600] }]}>
              ₹{((data?.fees?.totalCollected || 0) / 100).toLocaleString('en-IN')}
            </Text>
          </View>

          <View style={styles.feeComparisonItem}>
            <View style={[styles.feeComparisonBar, { height: `${(data?.fees?.totalOutstanding / (data?.fees?.totalBilled || 1)) * 100}%`, backgroundColor: colors.error[600] }]} />
            <Text variant="labelSmall" style={styles.feeComparisonLabel}>Outstanding</Text>
            <Text variant="titleMedium" style={[styles.feeComparisonValue, { color: colors.error[600] }]}>
              ₹{((data?.fees?.totalOutstanding || 0) / 100).toLocaleString('en-IN')}
            </Text>
          </View>
        </View>
      </Surface>

      {/* Aging Buckets */}
      {data?.fees?.agingBuckets && (
        <Surface style={styles.chartCard} elevation={1}>
          <Text variant="titleMedium" style={styles.chartTitle}>Outstanding by Age</Text>
          <Text variant="bodySmall" style={styles.chartSubtitle}>Follow-up priority</Text>

          {[
            { key: 'current', label: '0-30 days', color: colors.success[600] },
            { key: '30to60', label: '30-60 days', color: colors.warning[600] },
            { key: '60to90', label: '60-90 days', color: colors.error[500] },
            { key: 'over90', label: '90+ days', color: colors.error[700] },
          ].map(({ key, label, color }) => {
            const value = data.fees.agingBuckets[key as keyof typeof data.fees.agingBuckets] || 0;
            if (value === 0) return null;

            return (
              <View key={key} style={styles.comparisonItem}>
                <Text variant="bodyMedium" style={styles.comparisonLabel}>{label}</Text>
                <View style={styles.comparisonBarContainer}>
                  <View
                    style={[
                      styles.comparisonBar,
                      {
                        width: `${(value / (data.fees.totalOutstanding || 1)) * 100}%`,
                        backgroundColor: color,
                      },
                    ]}
                  />
                  <Text variant="labelMedium" style={[styles.comparisonValue, { color }]}>
                    ₹{(value / 100).toLocaleString('en-IN')}
                  </Text>
                </View>
              </View>
            );
          })}
        </Surface>
      )}
    </>
  );
};

// Learning Detail View Component
const LearningDetailView: React.FC<{
  data: SuperAdminAnalytics;
  timePeriod: 'daily' | 'weekly' | 'monthly';
  setTimePeriod: (period: 'daily' | 'weekly' | 'monthly') => void;
}> = ({ data, timePeriod, setTimePeriod }) => {
  return (
    <>
      {/* Time Period Filter Chips */}
      <View style={styles.filterChips}>
        <Chip
          selected={timePeriod === 'daily'}
          onPress={() => setTimePeriod('daily')}
          style={styles.filterChip}
        >
          Daily
        </Chip>
        <Chip
          selected={timePeriod === 'weekly'}
          onPress={() => setTimePeriod('weekly')}
          style={styles.filterChip}
        >
          Weekly
        </Chip>
        <Chip
          selected={timePeriod === 'monthly'}
          onPress={() => setTimePeriod('monthly')}
          style={styles.filterChip}
        >
          Monthly
        </Chip>
      </View>

      {/* Participation Rate */}
      <Surface style={styles.metricCardLarge} elevation={2}>
        <Text variant="labelLarge" style={styles.metricCardLabel}>Test Participation</Text>
        <Text variant="displayLarge" style={[styles.metricCardValue, { color: colors.info[600] }]}>
          {Math.round(data?.academics?.participationRate || 0)}%
        </Text>
        <Text variant="bodySmall" style={styles.metricCardSubtext}>students taking tests</Text>
      </Surface>

      {/* Subject Performance Comparison */}
      {data?.academics?.avgScoreBySubject && data.academics.avgScoreBySubject.length > 0 && (
        <Surface style={styles.chartCard} elevation={1}>
          <Text variant="titleMedium" style={styles.chartTitle}>Subject Performance</Text>
          <Text variant="bodySmall" style={styles.chartSubtitle}>Average scores by subject</Text>

          {data.academics.avgScoreBySubject.map((subject) => {
            const scoreColor = subject.avgScore >= 75 ? colors.success[600] :
                              subject.avgScore >= 60 ? colors.warning[600] : colors.error[600];

            return (
              <View key={subject.subjectId} style={styles.comparisonItem}>
                <Text variant="bodyMedium" style={styles.comparisonLabel}>{subject.subjectName}</Text>
                <View style={styles.comparisonBarContainer}>
                  <View
                    style={[
                      styles.comparisonBar,
                      {
                        width: `${subject.avgScore}%`,
                        backgroundColor: scoreColor,
                      },
                    ]}
                  />
                  <Text variant="labelMedium" style={[styles.comparisonValue, { color: scoreColor }]}>
                    {Math.round(subject.avgScore)}%
                  </Text>
                </View>
                <Text variant="bodySmall" style={[styles.comparisonSubtext, { marginTop: spacing.xs }]}>
                  {Math.round(subject.participationRate)}% participation
                </Text>
              </View>
            );
          })}
        </Surface>
      )}
    </>
  );
};

            <Chip
              mode="flat"
              style={{ backgroundColor: attendanceRate >= 90 ? colors.success[50] : colors.warning[50] }}
              textStyle={{ color: attendanceRate >= 90 ? colors.success[700] : colors.warning[700], fontSize: 12 }}
            >
              {attendanceRate >= 90 ? 'Excellent' : attendanceRate >= 80 ? 'Good' : 'Needs Attention'}
            </Chip>
          </View>
          <Text variant="displayLarge" style={[styles.metricCardValue, { color: getAttendanceColor(attendanceRate) }]}>
            {Math.round(attendanceRate)}%
          </Text>
        </View>

        {/* Attendance Trends */}
        {trend7DaysData.length > 0 && (
          <View style={styles.chartContainer}>
            <Text variant="titleMedium" style={styles.chartTitle}>7-Day Trend</Text>
            <TrendChart data={trend7DaysData} showLabels showDots height={200} />
          </View>
        )}

        {/* Class-wise Attendance Breakdown */}
        {data?.attendance?.classesByConsistency && data.attendance.classesByConsistency.length > 0 && (
          <View style={styles.breakdownSection}>
            <Text variant="titleMedium" style={styles.breakdownTitle}>Top Classes by Consistency</Text>
            {data.attendance.classesByConsistency.slice(0, 5).map((classItem) => (
              <View key={classItem.classId} style={styles.breakdownItem}>
                <View style={styles.breakdownItemLeft}>
                  <Text variant="bodyLarge" style={styles.breakdownItemName}>{classItem.className}</Text>
                  <View style={styles.breakdownItemProgress}>
                    <View
                      style={[
                        styles.progressFillSmall,
                        {
                          width: `${classItem.avgRate}%`,
                          backgroundColor: getAttendanceColor(classItem.avgRate),
                        },
                      ]}
                    />
                  </View>
                </View>
                <View style={styles.breakdownItemRight}>
                  <Text variant="headlineSmall" style={[styles.breakdownItemValue, { color: getAttendanceColor(classItem.avgRate) }]}>
                    {Math.round(classItem.avgRate)}%
                  </Text>
                  {classItem.trend === 'improving' && (
                    <Chip
                      mode="flat"
                      style={{ backgroundColor: colors.success[50] }}
                      textStyle={{ color: colors.success[700], fontSize: 10 }}
                      icon={() => <TrendingUp size={12} color={colors.success[700]} />}
                    >
                      Improving
                    </Chip>
                  )}
                </View>
              </View>
            ))}
          </View>
        )}
      </Surface>

      {/* ============ FEE ANALYSIS ============ */}
      <Surface style={styles.sectionContainer} elevation={1}>
        <View style={styles.sectionHeaderRow}>
          <View style={[styles.sectionIcon, { backgroundColor: colors.primary[50] }]}>
            <DollarSign size={20} color={colors.primary[600]} />
          </View>
          <Text variant="titleLarge" style={styles.sectionHeaderTitle}>Fee Analysis</Text>
        </View>

        {/* Fee Realization Rate */}
        <View style={styles.metricCardLarge}>
          <View style={styles.metricCardHeader}>
            <Text variant="labelLarge" style={styles.metricCardLabel}>Collection Efficiency</Text>
            <Chip
              mode="flat"
              style={{ backgroundColor: (data?.fees?.realizationRate || 0) >= 85 ? colors.success[50] : colors.warning[50] }}
              textStyle={{ color: (data?.fees?.realizationRate || 0) >= 85 ? colors.success[700] : colors.warning[700], fontSize: 12 }}
            >
              {(data?.fees?.realizationRate || 0) >= 85 ? 'On Track' : 'Needs Follow-up'}
            </Chip>
          </View>
          <Text variant="displayLarge" style={[styles.metricCardValue, { color: colors.primary[600] }]}>
            {Math.round(data?.fees?.realizationRate || 0)}%
          </Text>
          <Text variant="bodySmall" style={styles.metricCardSubtext}>
            of billed fees collected
          </Text>
        </View>

        {/* Fee Summary Grid */}
        <View style={styles.feeGridContainer}>
          <View style={styles.feeGridItem}>
            <Text variant="labelSmall" style={styles.feeGridLabel}>Total Billed</Text>
            <Text variant="headlineMedium" style={styles.feeGridValue}>
              ₹{((data?.fees?.totalBilled || 0) / 100).toLocaleString('en-IN')}
            </Text>
          </View>
          <View style={styles.feeGridItem}>
            <Text variant="labelSmall" style={[styles.feeGridLabel, { color: colors.success[600] }]}>Collected</Text>
            <Text variant="headlineMedium" style={[styles.feeGridValue, { color: colors.success[600] }]}>
              ₹{((data?.fees?.totalCollected || 0) / 100).toLocaleString('en-IN')}
            </Text>
          </View>
          <View style={styles.feeGridItem}>
            <Text variant="labelSmall" style={[styles.feeGridLabel, { color: colors.error[600] }]}>Outstanding</Text>
            <Text variant="headlineMedium" style={[styles.feeGridValue, { color: colors.error[600] }]}>
              ₹{((data?.fees?.totalOutstanding || 0) / 100).toLocaleString('en-IN')}
            </Text>
          </View>
        </View>

        {/* Aging Analysis */}
        {data?.fees?.agingBuckets && (data.fees.agingBuckets.current > 0 || data.fees.agingBuckets['30to60'] > 0) && (
          <View style={styles.breakdownSection}>
            <Text variant="titleMedium" style={styles.breakdownTitle}>Outstanding by Age</Text>
            <View style={styles.agingContainer}>
              {data.fees.agingBuckets.current > 0 && (
                <View style={styles.agingItem}>
                  <View style={styles.agingItemHeader}>
                    <View style={[styles.agingDot, { backgroundColor: colors.success[600] }]} />
                    <Text variant="bodyMedium" style={styles.agingLabel}>Current (0-30 days)</Text>
                  </View>
                  <Text variant="titleLarge" style={styles.agingValue}>
                    ₹{((data.fees.agingBuckets.current || 0) / 100).toLocaleString('en-IN')}
                  </Text>
                </View>
              )}
              {data.fees.agingBuckets['30to60'] > 0 && (
                <View style={styles.agingItem}>
                  <View style={styles.agingItemHeader}>
                    <View style={[styles.agingDot, { backgroundColor: colors.warning[600] }]} />
                    <Text variant="bodyMedium" style={styles.agingLabel}>30-60 days</Text>
                  </View>
                  <Text variant="titleLarge" style={styles.agingValue}>
                    ₹{((data.fees.agingBuckets['30to60'] || 0) / 100).toLocaleString('en-IN')}
                  </Text>
                </View>
              )}
              {data.fees.agingBuckets['60to90'] > 0 && (
                <View style={styles.agingItem}>
                  <View style={styles.agingItemHeader}>
                    <View style={[styles.agingDot, { backgroundColor: colors.error[500] }]} />
                    <Text variant="bodyMedium" style={styles.agingLabel}>60-90 days</Text>
                  </View>
                  <Text variant="titleLarge" style={styles.agingValue}>
                    ₹{((data.fees.agingBuckets['60to90'] || 0) / 100).toLocaleString('en-IN')}
                  </Text>
                </View>
              )}
              {data.fees.agingBuckets.over90 > 0 && (
                <View style={styles.agingItem}>
                  <View style={styles.agingItemHeader}>
                    <View style={[styles.agingDot, { backgroundColor: colors.error[700] }]} />
                    <Text variant="bodyMedium" style={styles.agingLabel}>90+ days</Text>
                  </View>
                  <Text variant="titleLarge" style={[styles.agingValue, { color: colors.error[700] }]}>
                    ₹{((data.fees.agingBuckets.over90 || 0) / 100).toLocaleString('en-IN')}
                  </Text>
                </View>
              )}
            </View>
          </View>
        )}
      </Surface>

      {/* ============ LEARNING ANALYSIS ============ */}
      {data?.academics?.avgScoreBySubject && data.academics.avgScoreBySubject.length > 0 && (
        <Surface style={styles.sectionContainer} elevation={1}>
          <View style={styles.sectionHeaderRow}>
            <View style={[styles.sectionIcon, { backgroundColor: colors.info[50] }]}>
              <Target size={20} color={colors.info[600]} />
            </View>
            <Text variant="titleLarge" style={styles.sectionHeaderTitle}>Learning Analysis</Text>
          </View>

          {/* Overall Participation */}
          <View style={styles.metricCardLarge}>
            <Text variant="labelLarge" style={styles.metricCardLabel}>Overall Test Participation</Text>
            <Text variant="displayLarge" style={[styles.metricCardValue, { color: colors.info[600] }]}>
              {Math.round(data?.academics?.participationRate || 0)}%
            </Text>
            <Text variant="bodySmall" style={styles.metricCardSubtext}>
              students actively taking tests
            </Text>
          </View>

          {/* Subject-wise Performance */}
          <View style={styles.breakdownSection}>
            <Text variant="titleMedium" style={styles.breakdownTitle}>Subject-wise Performance</Text>
            {data.academics.avgScoreBySubject.map((subject) => {
              const scoreColor = subject.avgScore >= 75 ? colors.success[600] :
                                subject.avgScore >= 60 ? colors.warning[600] : colors.error[600];
              const performanceLabel = subject.avgScore >= 75 ? 'Strong' :
                                      subject.avgScore >= 60 ? 'Moderate' : 'Needs Support';

              return (
                <View key={subject.subjectId} style={styles.performanceItem}>
                  <View style={styles.performanceHeader}>
                    <Text variant="bodyLarge" style={styles.performanceName}>{subject.subjectName}</Text>
                    <Chip
                      mode="flat"
                      style={{ backgroundColor: scoreColor + '15' }}
                      textStyle={{ color: scoreColor, fontSize: 10 }}
                    >
                      {performanceLabel}
                    </Chip>
                  </View>
                  <View style={styles.performanceMetrics}>
                    <View style={styles.performanceMetric}>
                      <Text variant="displaySmall" style={[styles.performanceValue, { color: scoreColor }]}>
                        {Math.round(subject.avgScore)}%
                      </Text>
                      <Text variant="bodySmall" style={styles.performanceLabel}>Avg Score</Text>
                    </View>
                    <View style={styles.performanceDivider} />
                    <View style={styles.performanceMetric}>
                      <Text variant="displaySmall" style={styles.performanceValue}>
                        {Math.round(subject.participationRate)}%
                      </Text>
                      <Text variant="bodySmall" style={styles.performanceLabel}>Participation</Text>
                    </View>
                  </View>
                  {/* Progress Bar */}
                  <View style={styles.performanceBar}>
                    <View style={[styles.performanceBarFill, { width: `${subject.avgScore}%`, backgroundColor: scoreColor }]} />
                  </View>
                </View>
              );
            })}
          </View>
        </Surface>
      )}

      {/* ============ ENGAGEMENT & OPERATIONS ============ */}
      <View style={styles.metricsRow}>
        <Surface style={styles.metricCard} elevation={1}>
          <View style={[styles.metricIconCircle, { backgroundColor: colors.info[50] }]}>
            <Zap size={24} color={colors.info[600]} />
          </View>
          <Text variant="displaySmall" style={styles.metricValue}>
            {Math.round(data?.engagement?.taskSubmissionRate || 0)}%
          </Text>
          <Text variant="bodySmall" style={styles.metricLabel}>Task Submission</Text>
        </Surface>

        <Surface style={styles.metricCard} elevation={1}>
          <View style={[styles.metricIconCircle, { backgroundColor: colors.warning[50] }]}>
            <Calendar size={24} color={colors.warning[600]} />
          </View>
          <Text variant="displaySmall" style={styles.metricValue}>
            {Math.round(data?.operations?.timetableCoverage || 0)}%
          </Text>
          <Text variant="bodySmall" style={styles.metricLabel}>Timetable Coverage</Text>
        </Surface>
      </View>
    </View>
  );
};

// Admin/Teacher Dashboard Component
const AdminDashboard: React.FC<{ data: AdminAnalytics; isLoading: boolean }> = ({
  data,
  isLoading,
}) => {
  if (isLoading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={colors.primary[600]} />
      </View>
    );
  }

  const weeklyTrendData: DataPoint[] =
    data?.presence?.weeklyTrend?.map(t => ({
      label: new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      value: t.rate,
    })) || [];

  return (
    <View style={styles.tabContent}>
      {/* Class Summary */}
      <Card style={styles.summaryCard}>
        <Text variant="titleLarge" style={styles.className}>
          {data?.summary?.className}
        </Text>
        <Text variant="bodyMedium" style={styles.classInfo}>
          {data?.summary?.totalStudents} students • {data?.summary?.classTeacher}
        </Text>
      </Card>

      {/* Weekly Attendance */}
      <Card style={styles.sectionCard}>
        <Text variant="titleMedium" style={styles.sectionTitle}>
          Weekly Attendance Trend
        </Text>
        <TrendChart data={weeklyTrendData} showLabels showDots />
        <Text variant="bodyMedium" style={styles.metricHighlight}>
          {Math.round(data?.presence?.steadyParticipation || 0)}% students with steady
          participation
        </Text>
      </Card>

      {/* Learning Progress */}
      <View style={styles.statsRow}>
        <KPICard
          title="Assignment On-Time"
          value={`${Math.round(data?.learning?.assignmentOnTimeRate || 0)}%`}
          icon={BookOpen}
          iconColor={colors.success[600]}
          iconBackgroundColor={colors.success[50]}
        />
        <KPICard
          title="Timetable Coverage"
          value={`${Math.round(data?.operations?.coveragePercent || 0)}%`}
          icon={Calendar}
          iconColor={colors.primary[600]}
          iconBackgroundColor={colors.primary[50]}
        />
      </View>

      {/* Syllabus Progress */}
      <Card style={styles.sectionCard}>
        <Text variant="titleMedium" style={styles.sectionTitle}>
          Syllabus Progress by Subject
        </Text>
        {data?.syllabus?.progressBySubject?.map(subject => (
          <View key={subject.subjectId} style={styles.progressItem}>
            <Text variant="bodyMedium" style={styles.subjectName}>
              {subject.subjectName}
            </Text>
            <View style={styles.progressBar}>
              <View
                style={[
                  styles.progressFill,
                  { width: `${subject.progress}%`, backgroundColor: colors.primary[600] },
                ]}
              />
            </View>
            <Text variant="bodySmall" style={styles.progressText}>
              {subject.completedTopics}/{subject.totalTopics} topics ({Math.round(subject.progress)}
              %)
            </Text>
          </View>
        ))}
      </Card>

      {/* Engagement */}
      <View style={styles.statsRow}>
        <KPICard
          title="Quiz Participation"
          value={`${Math.round(data?.engagement?.quizParticipation || 0)}%`}
          icon={TrendingUp}
          iconColor={colors.info[600]}
          iconBackgroundColor={colors.info[50]}
        />
        <KPICard
          title="Assignment Participation"
          value={`${Math.round(data?.engagement?.assignmentParticipation || 0)}%`}
          icon={BookOpen}
          iconColor={colors.warning[600]}
          iconBackgroundColor={colors.warning[50]}
        />
      </View>
    </View>
  );
};

// Student Dashboard Component
const StudentDashboard: React.FC<{ data: StudentAnalytics; isLoading: boolean }> = ({
  data,
  isLoading,
}) => {
  if (isLoading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={colors.primary[600]} />
      </View>
    );
  }

  const fourWeekTrendData: DataPoint[] =
    data?.attendanceRhythm?.fourWeekTrend?.map(t => ({
      label: `Week ${t.week}`,
      value: t.rate,
    })) || [];

  return (
    <View style={styles.tabContent}>
      {/* Student Summary */}
      <Card style={styles.summaryCard}>
        <Text variant="titleLarge" style={styles.className}>
          {data?.summary?.studentName}
        </Text>
        <Text variant="bodyMedium" style={styles.classInfo}>
          {data?.summary?.className}
        </Text>
      </Card>

      {/* Attendance This Month */}
      <Card style={styles.sectionCard}>
        <Text variant="titleMedium" style={styles.sectionTitle}>
          Attendance This Month
        </Text>
        <View style={styles.attendanceContainer}>
          <ProgressRing
            progress={
              (data?.attendanceRhythm?.daysAttendedThisMonth /
                Math.max(data?.attendanceRhythm?.totalDaysThisMonth, 1)) *
                100 || 0
            }
            size={120}
            label="Days Present"
          />
          <View style={styles.attendanceStats}>
            <Text variant="headlineMedium" style={styles.attendanceValue}>
              {data?.attendanceRhythm?.daysAttendedThisMonth || 0}/
              {data?.attendanceRhythm?.totalDaysThisMonth || 0}
            </Text>
            <Text variant="bodySmall" style={styles.attendanceLabel}>
              days attended
            </Text>
          </View>
        </View>
        {fourWeekTrendData.length > 0 && (
          <>
            <Text variant="titleSmall" style={styles.subSectionTitle}>
              4-Week Trend
            </Text>
            <TrendChart data={fourWeekTrendData} height={150} showLabels showDots />
          </>
        )}
      </Card>

      {/* Learning Progress */}
      {data?.progressHighlights?.closestToPersonalBest && (
        <Card style={styles.sectionCard}>
          <Text variant="titleMedium" style={styles.sectionTitle}>
            Personal Best
          </Text>
          <View style={styles.personalBest}>
            <Text variant="bodyLarge" style={styles.subjectName}>
              {data.progressHighlights.closestToPersonalBest.subjectName}
            </Text>
            <Text variant="headlineSmall" style={styles.bestScore}>
              {Math.round(data.progressHighlights.closestToPersonalBest.bestScore)}%
            </Text>
            <Text variant="bodySmall" style={styles.scoreLabel}>
              Your highest score
            </Text>
          </View>
        </Card>
      )}

      {/* Assignment Streak */}
      <View style={styles.statsRow}>
        <KPICard
          title="Assignments On-Time"
          value={data?.learning?.assignmentOnTimeStreak || 0}
          subtitle={`out of ${data?.learning?.totalAssignments || 0} total`}
          icon={BookOpen}
          iconColor={colors.success[600]}
          iconBackgroundColor={colors.success[50]}
        />
        <KPICard
          title="Overall Attendance"
          value={`${Math.round(data?.attendanceRhythm?.currentRate || 0)}%`}
          icon={TrendingUp}
          iconColor={colors.primary[600]}
          iconBackgroundColor={colors.primary[50]}
        />
      </View>

      {/* Fees Status */}
      {data?.fees && data.fees.status !== 'no_billing' && (
        <Card style={styles.sectionCard}>
          <Text variant="titleMedium" style={styles.sectionTitle}>
            Fee Status
          </Text>
          <View style={styles.feesOverview}>
            <View style={styles.feeRow}>
              <Text variant="bodyMedium" style={styles.feeLabel}>
                Total Billed
              </Text>
              <Text variant="bodyMedium" style={styles.feeValue}>
                ₹{((data.fees.totalBilled || 0) / 100).toLocaleString()}
              </Text>
            </View>
            <View style={styles.feeRow}>
              <Text variant="bodyMedium" style={styles.feeLabel}>
                Paid
              </Text>
              <Text variant="bodyMedium" style={[styles.feeValue, { color: colors.success[600] }]}>
                ₹{((data.fees.totalPaid || 0) / 100).toLocaleString()}
              </Text>
            </View>
            {data.fees.totalDue > 0 && (
              <View style={styles.feeRow}>
                <Text variant="bodyMedium" style={styles.feeLabel}>
                  Due
                </Text>
                <Text variant="bodyMedium" style={[styles.feeValue, { color: colors.error[600] }]}>
                  ₹{((data.fees.totalDue || 0) / 100).toLocaleString()}
                </Text>
              </View>
            )}
          </View>
        </Card>
      )}

      {/* Subject Progress */}
      <Card style={styles.sectionCard}>
        <Text variant="titleMedium" style={styles.sectionTitle}>
          Syllabus Progress
        </Text>
        {data?.progressHighlights?.syllabusProgress?.slice(0, 5).map(subject => (
          <View key={subject.subjectId} style={styles.progressItem}>
            <Text variant="bodyMedium" style={styles.subjectName}>
              {subject.subjectName}
            </Text>
            <View style={styles.progressBar}>
              <View
                style={[
                  styles.progressFill,
                  { width: `${subject.progress}%`, backgroundColor: colors.primary[600] },
                ]}
              />
            </View>
            <Text variant="bodySmall" style={styles.progressText}>
              {Math.round(subject.progress)}% complete
            </Text>
          </View>
        ))}
      </Card>
    </View>
  );
};

export default function AnalyticsScreen() {
  const { profile } = useAuth();
  const { selectedClass } = useClassSelection();
  const [refreshing, setRefreshing] = useState(false);

  const role = profile?.role;
  const canViewAnalytics = role === 'admin' || role === 'superadmin' || role === 'cb_admin' || role === 'student';

  // Fetch analytics data based on role
  const { data: analyticsData, isLoading, error, refetch } = useQuery({
    queryKey: ['analytics', role, selectedClass?.id, profile?.auth_id],
    queryFn: async () => {
      if (role === 'superadmin' || role === 'cb_admin') {
        const { data, error } = await supabase.rpc('get_super_admin_analytics' as any, {
          p_school_code: profile?.school_code,
          p_start_date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          p_end_date: new Date().toISOString().split('T')[0],
        });
        if (error) throw error;
        return data as unknown as SuperAdminAnalytics;
      } else if (role === 'admin' && selectedClass?.id) {
        const { data, error } = await supabase.rpc('get_admin_analytics' as any, {
          p_class_instance_id: selectedClass.id,
          p_start_date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          p_end_date: new Date().toISOString().split('T')[0],
        });
        if (error) throw error;
        return data as unknown as AdminAnalytics;
      } else if (role === 'student' && profile?.auth_id) {
        // First, get the student ID from the student table using auth_user_id
        const { data: studentData, error: studentError } = await supabase
          .from('student')
          .select('id')
          .eq('auth_user_id', profile.auth_id)
          .single();

        if (studentError) throw studentError;
        if (!studentData) throw new Error('Student record not found');

        const { data, error } = await supabase.rpc('get_student_analytics' as any, {
          p_student_id: studentData.id,
          p_start_date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          p_end_date: new Date().toISOString().split('T')[0],
        });
        if (error) throw error;
        return data as unknown as StudentAnalytics;
      }
      return null;
    },
    enabled: canViewAnalytics && (role !== 'admin' || !!selectedClass?.id),
    staleTime: 5 * 60 * 1000, // Cache for 5 minutes
    gcTime: 10 * 60 * 1000, // Keep in cache for 10 minutes
  });

  const onRefresh = async () => {
    setRefreshing(true);
    await refetch();
    setRefreshing(false);
  };

  if (!canViewAnalytics) {
    return (
      <View style={styles.container}>
        <View style={styles.header}>
          <View style={styles.headerContent}>
            <View style={styles.headerLeft}>
              <View style={styles.iconContainer}>
                <BarChart3 size={32} color={colors.text.inverse} />
              </View>
              <View>
                <Text variant="headlineSmall" style={styles.headerTitle}>
                  Analytics
                </Text>
                <Text variant="bodyLarge" style={styles.headerSubtitle}>
                  Access restricted
                </Text>
              </View>
            </View>
          </View>
        </View>
        <View style={styles.restrictedContainer}>
          <BarChart3 size={64} color={colors.text.tertiary} />
          <Text variant="titleLarge" style={styles.restrictedTitle}>
            Access Restricted
          </Text>
          <Text variant="bodyMedium" style={styles.restrictedMessage}>
            Analytics dashboard is not available for your role.
          </Text>
        </View>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <View style={styles.headerContent}>
          <View style={styles.headerLeft}>
            <View style={styles.iconContainer}>
              <BarChart3 size={32} color={colors.text.inverse} />
            </View>
            <View>
              <Text variant="headlineSmall" style={styles.headerTitle}>
                Analytics
              </Text>
              <Text variant="bodyLarge" style={styles.headerSubtitle}>
                {role === 'student' ? 'Your progress' : 'Performance insights'}
              </Text>
            </View>
          </View>
        </View>
      </View>

      {role === 'admin' && <ClassSelector />}

      <ScrollView
        style={styles.content}
        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}
      >
        {error ? (
          <View style={styles.errorContainer}>
            <Text style={styles.errorText}>Failed to load analytics</Text>
            <Text style={styles.errorSubtext}>{error.message}</Text>
          </View>
        ) : role === 'superadmin' || role === 'cb_admin' ? (
          <SuperAdminDashboard data={analyticsData as SuperAdminAnalytics} isLoading={isLoading} />
        ) : role === 'admin' ? (
          <AdminDashboard data={analyticsData as AdminAnalytics} isLoading={isLoading} />
        ) : role === 'student' ? (
          <StudentDashboard data={analyticsData as StudentAnalytics} isLoading={isLoading} />
        ) : null}
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background.app,
  },
  header: {
    backgroundColor: colors.primary[600],
    paddingTop: spacing.lg,
    paddingBottom: spacing.lg,
    paddingHorizontal: spacing.lg,
  },
  headerContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  headerLeft: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  iconContainer: {
    width: 48,
    height: 48,
    borderRadius: borderRadius.lg,
    backgroundColor: 'rgba(255, 255, 255, 0.2)',
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: spacing.md,
  },
  headerTitle: {
    color: colors.text.inverse,
    fontWeight: typography.fontWeight.bold,
  },
  headerSubtitle: {
    color: colors.text.inverse,
    opacity: 0.9,
  },
  restrictedContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingHorizontal: spacing.lg,
  },
  restrictedTitle: {
    color: colors.text.primary,
    marginTop: spacing.lg,
    marginBottom: spacing.sm,
  },
  restrictedMessage: {
    color: colors.text.secondary,
    textAlign: 'center',
  },
  content: {
    flex: 1,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
  },
  tabContent: {
    paddingBottom: spacing.xl * 2,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: spacing.xl * 2,
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: spacing.xl,
  },
  errorText: {
    color: colors.error[600],
    fontSize: 16,
    fontWeight: typography.fontWeight.semibold,
  },
  errorSubtext: {
    color: colors.text.secondary,
    marginTop: spacing.sm,
    textAlign: 'center',
  },
  // Empty State
  emptyState: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: spacing.xl * 3,
    paddingHorizontal: spacing.xl,
  },
  emptyIconContainer: {
    width: 96,
    height: 96,
    borderRadius: borderRadius.full,
    backgroundColor: colors.surface.secondary,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing.xl,
  },
  emptyTitle: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: spacing.sm,
    textAlign: 'center',
  },
  emptyMessage: {
    color: colors.text.secondary,
    textAlign: 'center',
    lineHeight: 24,
  },
  // Skeleton Loader
  skeletonCard: {
    backgroundColor: colors.surface.primary,
    padding: spacing.xl,
    borderRadius: borderRadius.lg,
    marginBottom: spacing.lg,
  },
  skeletonTitle: {
    height: 24,
    backgroundColor: colors.surface.tertiary,
    borderRadius: borderRadius.sm,
    marginBottom: spacing.md,
    width: '60%',
  },
  skeletonLine: {
    height: 16,
    backgroundColor: colors.surface.tertiary,
    borderRadius: borderRadius.sm,
    marginBottom: spacing.sm,
    width: '100%',
  },
  // Hero Card
  heroCard: {
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    marginBottom: spacing.xl,
  },
  heroTitle: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: spacing.xs,
  },
  heroSubtitle: {
    color: colors.text.secondary,
    marginBottom: spacing.xl,
  },
  heroStatsGrid: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    gap: spacing.md,
  },
  heroStat: {
    flex: 1,
    alignItems: 'center',
    paddingVertical: spacing.lg,
    backgroundColor: colors.background.app,
    borderRadius: borderRadius.lg,
  },
  heroStatValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginTop: spacing.sm,
  },
  heroStatLabel: {
    color: colors.text.secondary,
    marginTop: spacing.xs,
  },
  // Insight Card
  insightCard: {
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    marginBottom: spacing.lg,
  },
  insightHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  insightIconContainer: {
    width: 56,
    height: 56,
    borderRadius: borderRadius.full,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
  },
  insightContent: {
    flex: 1,
  },
  insightLabel: {
    color: colors.text.secondary,
    marginBottom: spacing.xs,
  },
  insightValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
  },
  insightBadge: {
    marginLeft: spacing.sm,
  },
  chartLabel: {
    color: colors.text.secondary,
    marginBottom: spacing.md,
    marginTop: spacing.sm,
  },
  // Fee Metrics
  feeMetricsGrid: {
    flexDirection: 'row',
    gap: spacing.xl,
    paddingTop: spacing.lg,
    borderTopWidth: 1,
    borderTopColor: colors.border.light,
  },
  feeMetric: {
    flex: 1,
    alignItems: 'center',
  },
  feeMetricLabel: {
    color: colors.text.secondary,
    marginBottom: spacing.sm,
    textTransform: 'uppercase',
  },
  feeMetricValue: {
    fontWeight: typography.fontWeight.bold,
  },
  feeMetricDivider: {
    width: 1,
    backgroundColor: colors.border.light,
  },
  // Card Header
  cardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.lg,
    gap: spacing.sm,
  },
  cardTitle: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
  },
  // Modern Subject Item
  subjectItemModern: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border.light,
  },
  subjectInfo: {
    flex: 1,
  },
  subjectNameModern: {
    fontWeight: typography.fontWeight.medium,
    color: colors.text.primary,
    marginBottom: spacing.xs,
  },
  subjectMetrics: {
    color: colors.text.tertiary,
  },
  subjectScore: {
    alignItems: 'flex-end',
  },
  scoreValue: {
    fontWeight: typography.fontWeight.bold,
  },
  // Metrics Row
  metricsRow: {
    flexDirection: 'row',
    gap: spacing.md,
    marginTop: spacing.md,
  },
  metricCard: {
    flex: 1,
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    alignItems: 'center',
  },
  metricIconCircle: {
    width: 56,
    height: 56,
    borderRadius: borderRadius.full,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing.md,
  },
  metricValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: spacing.xs,
  },
  metricLabel: {
    color: colors.text.secondary,
    textAlign: 'center',
  },
  // Detailed Analytics Sections
  sectionContainer: {
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    marginBottom: spacing.xl,
  },
  sectionHeaderRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.xl,
    gap: spacing.md,
  },
  sectionIcon: {
    width: 40,
    height: 40,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    justifyContent: 'center',
  },
  sectionHeaderTitle: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
  },
  metricCardLarge: {
    backgroundColor: colors.background.app,
    borderRadius: borderRadius.lg,
    padding: spacing.xl,
    marginBottom: spacing.lg,
  },
  metricCardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  metricCardLabel: {
    color: colors.text.secondary,
  },
  metricCardValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: spacing.xs,
  },
  metricCardSubtext: {
    color: colors.text.tertiary,
    fontSize: 12,
  },
  chartContainer: {
    marginBottom: spacing.lg,
  },
  chartTitle: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    marginBottom: spacing.md,
  },
  breakdownSection: {
    marginTop: spacing.lg,
  },
  breakdownTitle: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    marginBottom: spacing.lg,
  },
  breakdownItem: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border.light,
  },
  breakdownItemLeft: {
    flex: 1,
    marginRight: spacing.md,
  },
  breakdownItemName: {
    fontWeight: typography.fontWeight.medium,
    color: colors.text.primary,
    marginBottom: spacing.sm,
  },
  breakdownItemProgress: {
    height: 6,
    backgroundColor: colors.surface.tertiary,
    borderRadius: borderRadius.sm,
    overflow: 'hidden',
  },
  progressFillSmall: {
    height: '100%',
    borderRadius: borderRadius.sm,
  },
  breakdownItemRight: {
    alignItems: 'flex-end',
    gap: spacing.xs,
  },
  breakdownItemValue: {
    fontWeight: typography.fontWeight.bold,
    marginBottom: spacing.xs,
  },
  feeGridContainer: {
    flexDirection: 'row',
    gap: spacing.sm,
    marginBottom: spacing.lg,
  },
  feeGridItem: {
    flex: 1,
    backgroundColor: colors.background.app,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    alignItems: 'center',
  },
  feeGridLabel: {
    color: colors.text.secondary,
    marginBottom: spacing.sm,
    fontSize: 11,
    textTransform: 'uppercase',
    fontWeight: typography.fontWeight.semibold,
  },
  feeGridValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    textAlign: 'center',
  },
  agingContainer: {
    gap: spacing.md,
  },
  agingItem: {
    backgroundColor: colors.background.app,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
  },
  agingItemHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.sm,
    gap: spacing.sm,
  },
  agingDot: {
    width: 12,
    height: 12,
    borderRadius: borderRadius.full,
  },
  agingLabel: {
    color: colors.text.secondary,
    fontWeight: typography.fontWeight.medium,
  },
  agingValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
  },
  performanceItem: {
    backgroundColor: colors.background.app,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.md,
  },
  performanceHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  performanceName: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    flex: 1,
  },
  performanceMetrics: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'center',
    marginBottom: spacing.md,
    gap: spacing.lg,
  },
  performanceMetric: {
    flex: 1,
    alignItems: 'center',
  },
  performanceValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: spacing.xs,
  },
  performanceLabel: {
    color: colors.text.secondary,
    fontSize: 11,
  },
  performanceDivider: {
    width: 1,
    height: 40,
    backgroundColor: colors.border.light,
  },
  performanceBar: {
    height: 6,
    backgroundColor: colors.surface.tertiary,
    borderRadius: borderRadius.sm,
    overflow: 'hidden',
  },
  performanceBarFill: {
    height: '100%',
    borderRadius: borderRadius.sm,
  },
  // Feature Selection Styles
  summaryHeader: {
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    marginBottom: spacing.xl,
  },
  summaryTitle: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: spacing.lg,
  },
  summaryStats: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'center',
  },
  summaryStatItem: {
    alignItems: 'center',
  },
  summaryStatLabel: {
    color: colors.text.secondary,
    marginBottom: spacing.xs,
  },
  summaryStatValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
  },
  summaryDivider: {
    width: 1,
    height: 32,
    backgroundColor: colors.border.light,
  },
  sectionLabel: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    marginBottom: spacing.lg,
  },
  featureGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.md,
  },
  featureCard: {
    flex: 1,
    minWidth: '47%',
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  featureIconBg: {
    width: 64,
    height: 64,
    borderRadius: borderRadius.full,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing.md,
  },
  featureCardTitle: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    marginBottom: spacing.sm,
    textAlign: 'center',
  },
  featureCardValue: {
    fontWeight: typography.fontWeight.bold,
    marginBottom: spacing.xs,
  },
  featureCardSubtitle: {
    color: colors.text.secondary,
    textAlign: 'center',
  },
  backButton: {
    backgroundColor: colors.surface.secondary,
    borderRadius: borderRadius.lg,
    padding: spacing.md,
    marginBottom: spacing.xl,
  },
  backButtonText: {
    color: colors.primary[600],
    fontWeight: typography.fontWeight.semibold,
  },
  // Filter Chips
  filterChips: {
    flexDirection: 'row',
    gap: spacing.sm,
    marginBottom: spacing.xl,
  },
  filterChip: {
    marginRight: 0,
  },
  // Chart Styles
  chartCard: {
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.xl,
    padding: spacing.xl,
    marginBottom: spacing.xl,
  },
  chartSubtitle: {
    color: colors.text.secondary,
    marginBottom: spacing.lg,
  },
  // Comparison Bar Styles
  comparisonItem: {
    marginBottom: spacing.lg,
  },
  comparisonLabel: {
    fontWeight: typography.fontWeight.medium,
    color: colors.text.primary,
    marginBottom: spacing.sm,
  },
  comparisonBarContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing.md,
  },
  comparisonBar: {
    height: 32,
    borderRadius: borderRadius.md,
    minWidth: 2,
  },
  comparisonValue: {
    fontWeight: typography.fontWeight.bold,
    minWidth: 50,
    textAlign: 'right',
  },
  comparisonSubtext: {
    color: colors.text.tertiary,
    fontSize: 11,
  },
  // Fee Comparison (Double Bar Chart Style)
  feeComparisonContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'flex-end',
    height: 200,
    paddingVertical: spacing.lg,
    gap: spacing.xl,
  },
  feeComparisonItem: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'flex-end',
  },
  feeComparisonBar: {
    width: '100%',
    borderTopLeftRadius: borderRadius.md,
    borderTopRightRadius: borderRadius.md,
    minHeight: 20,
    marginBottom: spacing.md,
  },
  feeComparisonLabel: {
    color: colors.text.secondary,
    marginBottom: spacing.xs,
    textAlign: 'center',
  },
  feeComparisonValue: {
    fontWeight: typography.fontWeight.bold,
    textAlign: 'center',
  },
  // Legacy styles (keeping for backward compatibility)
  statsRow: {
    flexDirection: 'row',
    gap: spacing.md,
    marginBottom: spacing.md,
  },
  sectionCard: {
    padding: spacing.lg,
    marginBottom: spacing.lg,
    backgroundColor: colors.surface.primary,
    borderRadius: borderRadius.lg,
  },
  sectionTitle: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    marginBottom: spacing.lg,
  },
  subSectionTitle: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
    marginTop: spacing.lg,
    marginBottom: spacing.md,
  },
  summaryCard: {
    padding: spacing.lg,
    marginBottom: spacing.lg,
    backgroundColor: colors.primary[50],
    borderRadius: borderRadius.lg,
  },
  className: {
    fontWeight: typography.fontWeight.bold,
    color: colors.primary[900],
  },
  classInfo: {
    color: colors.primary[700],
    marginTop: spacing.xs,
  },
  feesContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-around',
  },
  feesStats: {
    gap: spacing.sm,
  },
  feesLabel: {
    color: colors.text.secondary,
  },
  subjectRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.md,
    paddingBottom: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border.light,
  },
  subjectName: {
    fontWeight: typography.fontWeight.medium,
    color: colors.text.primary,
    flex: 1,
  },
  subjectStats: {
    alignItems: 'flex-end',
  },
  subjectScore: {
    color: colors.text.primary,
    fontWeight: typography.fontWeight.semibold,
  },
  subjectParticipation: {
    color: colors.text.secondary,
    marginTop: spacing.xs,
  },
  metricHighlight: {
    color: colors.success[700],
    fontWeight: typography.fontWeight.semibold,
    marginTop: spacing.md,
    textAlign: 'center',
  },
  progressItem: {
    marginBottom: spacing.lg,
  },
  progressBar: {
    height: 8,
    backgroundColor: colors.surface.tertiary,
    borderRadius: borderRadius.sm,
    marginTop: spacing.sm,
    marginBottom: spacing.xs,
    overflow: 'hidden',
  },
  progressFill: {
    height: '100%',
    borderRadius: borderRadius.sm,
  },
  progressText: {
    color: colors.text.secondary,
  },
  attendanceContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-around',
    marginBottom: spacing.lg,
  },
  attendanceStats: {
    alignItems: 'center',
  },
  attendanceValue: {
    fontWeight: typography.fontWeight.bold,
    color: colors.text.primary,
  },
  attendanceLabel: {
    color: colors.text.secondary,
  },
  personalBest: {
    alignItems: 'center',
    paddingVertical: spacing.lg,
  },
  bestScore: {
    fontWeight: typography.fontWeight.bold,
    color: colors.success[600],
    marginVertical: spacing.sm,
  },
  scoreLabel: {
    color: colors.text.secondary,
  },
  feesOverview: {
    gap: spacing.md,
  },
  feeRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  feeLabel: {
    color: colors.text.secondary,
  },
  feeValue: {
    fontWeight: typography.fontWeight.semibold,
    color: colors.text.primary,
  },
});
